---
title: "ãƒ˜ãƒ«ãƒ‘ãƒ¼ã‚¯ãƒ©ã‚¹ã‚’ä½œæˆã—ã¦OpenSearchã‚’ç”¨ã„ãŸã‚³ãƒ¼ãƒ‰ã®ãƒ†ã‚¹ãƒˆã‚’ã‚„ã‚Šã‚„ã™ãã™ã‚‹"
emoji: "ğŸ”"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [ "OpenSearch", "Elasticsearch", "python", "pytest" ]
published: false
---

OpenSearch ã‚„ Elasticsearch ã‚’ä½¿ã£ãŸã‚³ãƒ¼ãƒ‰ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹éš›ã€ãƒ†ã‚¹ãƒˆç”¨ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½œæˆã—ãŸã‚Šã€å‰Šé™¤ã—ãŸã‚Šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ãƒ†ã‚¹ãƒˆç”¨ã«ã‚³ãƒ³ãƒ†ãƒŠã‚’åˆ¥é€”ç«‹ã¡ä¸Šã’ã¦ã‚‚è‰¯ã„ã®ã§ã™ãŒã€ã‚ã¾ã‚Šã‚³ãƒ³ãƒ†ãƒŠç«‹ã¡ä¸Šã’ãŸã‚Šã™ã‚‹ã®ãŒé¢å€’ã ã£ãŸãŸã‚ã€ä»Šå›ã¯é–‹ç™ºç’°å¢ƒã§ä½¿ç”¨ã—ã¦ã„ã‚‹ã‚³ãƒ³ãƒ†ãƒŠã‚’ä½¿ã„å›ã™ã“ã¨ã‚’å‰æã¨ã—ã¦ã€ãƒ†ã‚¹ãƒˆç”¨ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½œæˆã€å‰Šé™¤ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼ã‚¯ãƒ©ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚


```python:helper.py
class OpenSearchTestHelper:
    def __init__(self, hosts=[{"host": "localhost", "port": 9200}]):
        user = "user"
        password = "password"
        
        auth = (user, password)
        self.client = OpenSearch(
            hosts=hosts,
            http_compress=True,
            http_auth=auth,
            use_ssl=True,
            verify_certs=False,
            ssl_show_warn=False,
        )
        self.test_indices = set()

    def create_index(self, index_name: str):
        """
        ãƒ†ã‚¹ãƒˆç”¨ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½œæˆã—ã€ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ãƒªã‚¹ãƒˆã«è¿½åŠ 
        
        Args:
            index_name (str): ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹å
            
        """
        self.client.indices.create(index=index_name, body={}) # å¿…è¦ã«å¿œã˜ã¦è¨­å®šã‚’è¿½åŠ 
        self.test_indices.add(index_name)

    def cleanup_indices(self, additional_indices: list[str] | None = None):
        """
        ç™»éŒ²ã•ã‚ŒãŸå…¨ã¦ã®ãƒ†ã‚¹ãƒˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å‰Šé™¤
        
        Args:
            additional_indices (list[str]): è¿½åŠ ã§å‰Šé™¤ã™ã‚‹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹åã€‚ãƒ†ã‚¹ãƒˆå¯¾è±¡ã‚³ãƒ¼ãƒ‰å†…ã§ä½œæˆã—ãŸã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å‰Šé™¤ã™ã‚‹éš›ã«ä½¿ç”¨
        """
        if additional_indices is None:
            additional_indices = []

        for index in additional_indices:
            if self.client.indices.exists(index=index):
                self.client.indices.delete(index=index)

        for index in self.test_indices:
            if self.client.indices.exists(index=index):
                self.client.indices.delete(index=index)
                
        self.test_indices.clear()

    def refresh(self, index_name: str):
        """
        æŒ‡å®šã—ãŸã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
        
        Args:
            index_name (str): ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹å
        """
        self.client.indices.refresh(index=index_name)
```

pytestã‚’ä½¿ã£ã¦ã„ã‚‹å ´åˆã€ conftest.py ã«ãƒ˜ãƒ«ãƒ‘ãƒ¼ã‚¯ãƒ©ã‚¹ã‚’ä½¿ã†ãŸã‚ã® fixture ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```python:conftest.py
@pytest.fixture
def opensearch_helper():
    helper = OpenSearchTestHelper()
    yield helper
    helper.cleanup_indices()
```


ã“ã‚Œã§ã€ãƒ†ã‚¹ãƒˆç”¨ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½œæˆã€å‰Šé™¤ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼ã‚¯ãƒ©ã‚¹ã‚’ä½¿ã£ã¦ã€ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãã“ã¨ãŒã§ãã¾ã™ã€‚
ãƒ†ã‚¹ãƒˆãŒçµ‚äº†ã—ãŸéš›ã«ã¯ã€ä½œæˆã—ãŸã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒå‰Šé™¤ã•ã‚Œã‚‹ãŸã‚ã€ãƒ†ã‚¹ãƒˆå¾Œã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ãŒä¸è¦ã«ãªã‚Šã¾ã™ã€‚

```python:test_code.py
def test_create_index(opensearch_helper):
    index_name = opensearch_helper.create_index("test_index")
    
    sut = SomeClass()
    sut.some_method()
    
    assert not opensearch_helper.client.indices.exists(index=index_name)
```

/ä»¥ä¸Š