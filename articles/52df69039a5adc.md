---
title: "Pub/Sub ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å‹‰å¼·ãŒã¦ã‚‰é€šçŸ¥æ©Ÿèƒ½ã‚’ä½œã£ã¦ã¿ãŸ"
emoji: "ğŸ””"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Python", "FastAPI", "PubSub", "FastAPI"]
published: true
---

Observer ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚„ Pub/Sub ãƒ‘ã‚¿ãƒ¼ãƒ³ã«ã¤ã„ã¦ã€çŸ¥è­˜ã¨ã—ã¦ã¯ç†è§£ã—ã¦ã„ã‚‹ã¤ã‚‚ã‚Šã§ã‚‚å®Ÿéš›ã«ã‚¼ãƒ­ã‚¤ãƒã§ä½œã£ãŸã“ã¨ãŒãªã‹ã£ãŸã®ã§ã€å‹‰å¼·ãŒã¦ã‚‰é€šçŸ¥æ©Ÿèƒ½ã‚’ä½œã£ã¦ã¿ã¾ã—ãŸã€‚

## ä½œæˆã—ãŸé€šçŸ¥æ©Ÿèƒ½

é€šçŸ¥æ©Ÿèƒ½ãƒ»ãƒ»ãƒ»ã¨ã¯ã„ã„ã¤ã¤ã€å®Ÿéš›ã®é€šçŸ¥ã¯è¡Œã‚ãšã€ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›ã™ã‚‹ã ã‘ã®ã‚·ãƒ³ãƒ—ãƒ«ãªã‚‚ã®ã§ã™ã€‚ãŸã ã—ã€å®Ÿéš›ã®ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã‚’æƒ³å®šã—ã¦ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’è¨­è¨ˆã—ã¦ã„ã¾ã™ã€‚

- è³¼èª­è€…(Subscriber)ã¯ã€é€šçŸ¥ã‚’å—ã‘å–ã‚‹ãŸã‚ã®æ‰‹æ®µï¼ˆãƒ¡ãƒ¼ãƒ«ã€Slackã€LINEãªã©ï¼‰ã¨é€šçŸ¥ã‚’å—ã‘å–ã‚‹ç¨®é¡ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ï¼‰ã‚’ç™»éŒ²ã§ãã‚‹
- é€šçŸ¥è€…(Publisher)ã¯ã€é€šçŸ¥æ‰‹æ®µã‚’æ„è­˜ã›ãšã€ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã ã‘ã‚’é–¢å¿ƒã¨ã—ã¦æŒã¡ã€SubscriberãŸã¡ã«é€šçŸ¥ã‚’é€ã‚‹
- é€šçŸ¥ã‚’å—ã‘å–ã‚‹ãŸã‚ã®æ‰‹æ®µã¯ã¨ã—ã¦ã®ã‚¤ãƒ³ãƒ•ãƒ©å®Ÿè£…ã¯ Subscriber ã«ç›´æ¥æŒãŸã›ãšã€NotificationInfrastructure ã¨ã„ã†ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã«å§”è­²ã™ã‚‹

ä»Šå›å®Ÿè£…ã—ãŸã‚³ãƒ¼ãƒ‰ã¯ã“ã¡ã‚‰ã«ã‚ã‚Šã¾ã™
[pub-sub-learn](https://github.com/killinsun/pub-sub-learn)


## Subscriber

```python:subscribers.py
import abc
from pydantic import EmailStr
from loguru import logger

from app.infrastructure import NotificationInfrastructure


class Subscriber(abc.ABC):

    def __init__(self, destination: str | list[str] = None):
        self._infra: NotificationInfrastructure | None = None
        self.destination = destination

    @property
    def infra(self) -> NotificationInfrastructure:
        if self._infra is None:
            raise ValueError("NotificationInfrastructure is not set")

        return self._infra

    @infra.setter
    def infra(self, infra: NotificationInfrastructure):
        self._infra = infra
        logger.info(f"Setting infrastructure for {self.__class__.__name__}")

    @abc.abstractmethod
    def get_event_type(self) -> str:
        raise NotImplementedError

    @abc.abstractmethod
    def get_subscriber_info(self) -> dict:
        raise NotImplementedError

    def notify(self, destination: str | list[str], title: str, message: str):
        self.infra.send(destination=destination, title=title, content=message)

    def validate(self):
        self.infra.validate_destination(self.destination)


class MailSubscriber(Subscriber):
    def __init__(self, event_type: str, mail_to: list[EmailStr]):
        super().__init__(destination=mail_to)

        self.event_type = event_type
        self.mail_to = mail_to

    def get_event_type(self) -> str:
        return self.event_type

    def get_subscriber_info(self) -> dict:
        return {
            "type": "mail",
            "email_to": self.mail_to,
        }
```

### æŠ½è±¡ã‚¯ãƒ©ã‚¹ Subscriber

ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã¨ã—ã¦ `notify` ã¨ `validate` ã‚’æŒã¡ã€å®Ÿéš›ã¯ `infra` ã«å§”è­²ã—ã¦ã„ã¾ã™ã€‚

### MailSubscriber

ãƒ¡ãƒ¼ãƒ«é€šçŸ¥ã‚’å—ã‘å–ã‚‹ Subscriber ã§ã™ã€‚ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã§ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å—ã‘å–ã‚Šã¾ã™ã€‚

## Infrastructure

```python:infrastructure.py
import abc

from loguru import logger


class NotificationInfrastructure(abc.ABC):
    @abc.abstractmethod
    def send(self, destination: str | list[str], title: str, content: str):
        raise NotImplementedError

    @abc.abstractmethod
    def validate_destination(self, destination: str | list[str]):
        raise NotImplementedError


class NullNotificationInfra(NotificationInfrastructure):
    """
    ä½•ã‚‚ã—ãªã„é€šçŸ¥ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£
    """

    def send(self, destination: str | list[str], title: str, content: str):
        pass

    def validate_destination(self, destination: str | list[str]):
        pass


class MailNotificationInfra(NotificationInfrastructure):
    def send(self, destination: str | list[str], title: str, content: str):
        # å…·ä½“çš„ãªãƒ¡ãƒ¼ãƒ«é€ä¿¡å‡¦ç†ã¯ã“ã“ã§ã¯çœç•¥ã€‚
        logger.info(f"Sending email to {destination}")

    def validate_destination(self, destination: str | list[str]):
        if not isinstance(destination, list):
            destination = [destination]
        for email in destination:
            if not "@" in email:  # This is a simple check, not a full validation
                raise ValueError(f"Invalid email address: {email}")
```

### æŠ½è±¡ã‚¯ãƒ©ã‚¹ NotificationInfrastructure

é€šçŸ¥ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã§ã™ã€‚`send` ã¨ `validate_destination` ã‚’æŒã¡ã¾ã™ã€‚
`send` ã¯é€šçŸ¥ã‚’é€ä¿¡ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã§ã€`validate_destination` ã¯é€ä¿¡å…ˆã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡Œã†ãƒ¡ã‚½ãƒƒãƒ‰ã§ã™ã€‚

ä»Šå›ã¯ã‚µãƒ³ãƒ—ãƒ«ã¨ã—ã¦ `MailNotificationInfra` ã¨ `NullNotificationInfra` ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚
ã“ã“ã§ Slack ãªã©ä»–ã®é€šçŸ¥æ‰‹æ®µã‚’å®Ÿè£…ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

### MailNotificationInfra

ãƒ¡ãƒ¼ãƒ«é€šçŸ¥ã®ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ã§ã™ã€‚`send` ã¯ãƒ¡ãƒ¼ãƒ«ã®é€ä¿¡å‡¦ç†ã‚’è¡Œã„ã¾ã™ãŒã€ã“ã“ã§ã¯`logger`ã§å‡ºåŠ›ã™ã‚‹ã ã‘ã«ç•™ã‚ã¦ã„ã¾ã™ã€‚

å®Ÿéš›ã«ã¯ã€SendGrid ã‚„ AWS SES ãªã©ã®ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚µãƒ¼ãƒ“ã‚¹ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã«ãªã‚‹ã§ã—ã‚‡ã†ã€‚

ã¾ãŸã€`validate_destination` ã¯ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡Œã„ã¾ã™ãŒã€ã“ã“ã§ã¯ç°¡æ˜“çš„ãªãƒã‚§ãƒƒã‚¯ã«ç•™ã‚ã¦ã„ã¾ã™ã€‚å®Ÿéš›ã¯ Pydantic ã® EmailStr ãªã©ã‚’ä½¿ã£ã¦å³å¯†ãªãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡Œã†ã¹ãã§ã™ã€‚

### NullNotificationInfra

TDDã‚’ã™ã‚‹éš›ã«ä½œã£ãŸä½•ã‚‚ã—ãªã„é€šçŸ¥ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ã§ã™ã€‚

## NotificationService

```python:notification_service.py
from collections import defaultdict

from app.infrastructure import NotificationInfrastructure
from app.subscribers import Subscriber


class NotificationService:
    def __init__(self):
        self.subscribers: dict[str, list[Subscriber]] = defaultdict(list)
        self.infrastructures: dict[str, NotificationInfrastructure] = {}

    def register_infrastructure(
        self, subscriber_type: str, infrastructure: NotificationInfrastructure
    ):
        """
        NotificationInfrastructure ã‚’å®Ÿè£…ã—ãŸã‚¯ãƒ©ã‚¹ã‚’ç™»éŒ²ã™ã‚‹ã€‚

        :param subscriber_type: str Subscriber ã‚¿ã‚¤ãƒ—ã€‚ä¸»ã«åå‰
        :param infrastructure: NotificationInfrastructure NotificationInfrastructure ã‚’å®Ÿè£…ã—ãŸã‚¯ãƒ©ã‚¹
        :return:
        """

        self.infrastructures[subscriber_type] = infrastructure

    def get_infrastructure(self, subscriber_type: str) -> NotificationInfrastructure:
        return self.infrastructures[subscriber_type]

    def add_subscriber(self, event_type: str, subscriber: Subscriber):
        """
        Subscriber ã‚’ç™»éŒ²ã™ã‚‹ã€‚
        subscriber_type ã«å¯¾å¿œã™ã‚‹ NotificationInfrastructure ã‚’ register_infrastructure ã§ç™»éŒ²ã™ã‚‹å¿…è¦ãŒã‚ã‚‹

        :param event_type: str ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—
        :param subscriber: Subscriber ç™»éŒ²ã™ã‚‹ Subscriber ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
        :return:
        """
        subscriber_type = subscriber.__class__.__name__
        infrastructure = self.get_infrastructure(subscriber_type)
        subscriber.infra = infrastructure
        subscriber.validate()

        self.subscribers[event_type].append(subscriber)
        
    def notify(self, event_type: str, title: str, message: str):
        """
        ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ Subscriber ã«é€šçŸ¥ã‚’é€ä¿¡ã™ã‚‹
        :param event_type: str ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—
        :param title: str é€šçŸ¥ã‚¿ã‚¤ãƒˆãƒ«
        :param message: str ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æœ¬æ–‡
        :return:
        """

        for subscriber in self.subscribers[event_type]:
            subscriber.notify(
                destination=subscriber.destination, title=title, message=message
            )
```

### NotificationService

Infrastructures ã¨ Subscribers ã‚’æŒã¡ã€Subscriber ã«é€šçŸ¥ã‚’é€ä¿¡ã™ã‚‹çª“å£ã¨ãªã‚Šã¾ã™ã€‚
`add_subscriber` ã§ Subscriber ã‚’ç™»éŒ²ã—ã¾ã™ãŒã€å¯¾å¿œã—ãŸ `NotificationInfrastructure` ã‚’ã‚ã‚‰ã‹ã˜ã‚ç™»éŒ²ã—ã¦ãŠã“ãªã„ã¨`validate`ã§ä¾‹å¤–ãŒç™ºç”Ÿã—ã¾ã™ã€‚


## Controller

```python:main.py
from fastapi import FastAPI
from pydantic import BaseModel, EmailStr
from loguru import logger

from app.infrastructure import MailNotificationInfra
from app.notification_service import NotificationService
from app.subscribers import MailSubscriber

app = FastAPI()


class EmailSubscribeRequest(BaseModel):
    email: EmailStr
    event_type: str


class Event(BaseModel):
    event_type: str
    data: dict


notification_service = NotificationService()
mail_infra = MailNotificationInfra()
notification_service.register_infrastructure(
    subscriber_type="MailSubscriber", infrastructure=mail_infra
)


@app.post("/subscribe")
async def subscribe(subscribe_req: EmailSubscribeRequest):
    logger.info(f"Subscribing {subscribe_req.email} to {subscribe_req.event_type}")

    mail_subscriber = MailSubscriber(
        event_type=subscribe_req.event_type, mail_to=[subscribe_req.email]
    )
    notification_service.add_subscriber(
        event_type=subscribe_req.event_type, subscriber=mail_subscriber
    )

    return {"email": subscribe_req.email, "event_type": subscribe_req.event_type}


@app.post("/publish")
async def publish(event: Event):
    logger.info(f"Publishing {event.event_type} event")
    logger.debug(event.data)

    notification_service.notify(
        event_type=event.event_type,
        title="New article published",
        message=f"New article published: {event.data}",
    )

    return {"message": "Event published"}
```

FastAPI ã§å‹•ä½œã™ã‚‹APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§ã™ã€‚ `/subscribe` ã§ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç™»éŒ²ã—ã€ `/publish` ã§é€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã™ã€‚

`/subscribe` ã§ã¯ãƒ¡ãƒ¼ãƒ«ã«é–¢ã™ã‚‹æƒ…å ±ã—ã‹å—ã‘å–ã£ã¦ã„ã¾ã›ã‚“ãŒã€ä»–ã®é€šçŸ¥æ‰‹æ®µã‚’æä¾›ã™ã‚‹å ´åˆã¯æ”¹è‰¯ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã§ã—ã‚‡ã†ã€‚


## å‹•ä½œç¢ºèª

### è³¼èª­è€…ç™»éŒ²

Postman ã‚’ä½¿ã£ã¦ `/subscribe` ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¾ã™ã€‚

![Postman_subscribe](/images/pubsub_learn_1.png)
`new_article` ã‚¤ãƒ™ãƒ³ãƒˆãŒã‚ã£ãŸå ´åˆã« `test@example.com` ã«å¯¾ã™ã‚‹é€šçŸ¥ã‚’ç™»éŒ²ã—ã¦ã„ã¾ã™

```bash
2025-01-01 17:28:11.659 | INFO     | app.main:subscribe:31 - Subscribing test@example.com to new_article
2025-01-01 17:28:11.659 | INFO     | app.subscribers:infra:26 - Setting infrastructure for MailSubscriber
INFO:     127.0.0.1:52293 - "POST /subscribe HTTP/1.1" 200 OK
```

ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹ã¨ã€ `MailSubscriber`  ã‚’ä½œæˆã—ã€ `NotificationService` ã«ç™»éŒ²ã—ã¦ã„ã¾ã™ã€‚

### é€šçŸ¥

æ¬¡ã¯ `/publish` ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¦é€šçŸ¥ã‚’è¡Œã„ã¾ã™ã€‚

![Postman_publish](/images/pubsub_learn_2.png)

è³¼èª­ã—ãŸéš›ã¨åŒã˜ã‚ˆã†ã«ã€`new_article` ã‚¤ãƒ™ãƒ³ãƒˆã‚’é€ä¿¡ã—ã¦ã„ã¾ã™ã€‚

```bash
2025-01-01 17:28:16.524 | INFO     | app.main:publish:45 - Publishing new_article event
2025-01-01 17:28:16.524 | DEBUG    | app.main:publish:46 - {'title': 'Hello world', 'body': "Hey, what's up?"}
2025-01-01 17:28:16.524 | INFO     | app.infrastructure:send:32 - Sending email to ['test@example.com']
INFO:     127.0.0.1:52293 - "POST /publish HTTP/1.1" 200 OK
```

å…ˆã»ã©ã® Subscriber ã¯ `new_article` ã«å¯¾ã™ã‚‹è³¼èª­ã‚’ã—ã¦ã„ã‚‹ç‚ºã€ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ãŒç•°ãªã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ãŸå ´åˆ `test@example.com` ã«é€šçŸ¥ã¯è¡Œã‚ã‚Œã¾ã›ã‚“ã€‚


```bash
# ğŸ™… `new_user` ã¸ã®é€šçŸ¥ãªã®ã§ã€ä¸Šã§è³¼èª­ã—ãŸ Subscriber ã«ã¯é€šçŸ¥ãŒè¡Œã‚ã‚Œãªã„
2025-01-02 08:56:34.322 | INFO     | app.main:publish:45 - Publishing new_user event
2025-01-02 08:56:34.322 | DEBUG    | app.main:publish:46 - {'title': 'A new user joined', 'body': ''}
INFO:     127.0.0.1:56673 - "POST /publish HTTP/1.1" 200 OK

# ğŸ™† `new_article` ã¸ã®é€šçŸ¥ãªã®ã§ã€ä¸Šã§è³¼èª­ã—ãŸ Subscriber ã«é€šçŸ¥ãŒè¡Œã‚ã‚Œã‚‹
2025-01-02 08:56:45.708 | INFO     | app.main:publish:45 - Publishing new_article event
2025-01-02 08:56:45.708 | DEBUG    | app.main:publish:46 - {'title': 'Hello world', 'body': "Hey, what's up?"}
2025-01-02 08:56:45.708 | INFO     | app.infrastructure:send:32 - Sending email to ['test@example.com']
INFO:     127.0.0.1:56683 - "POST /publish HTTP/1.1" 200 OK
```


## ã¾ã¨ã‚

Pub/Sub ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ç”¨ã„ãŸé€šçŸ¥æ©Ÿèƒ½ã‚’ä½œæˆã—ã¾ã—ãŸã€‚

ä»Šå›ã¯è‡ªåˆ†ãªã‚Šã«è¨­è¨ˆã—ã¦ã¿ã¾ã—ãŸãŒã€ã‚„ã£ã¦ã„ã‚‹ã¨æŠ½è±¡ã‚¯ãƒ©ã‚¹ï¼ˆä»–ã®è¨€èªã®å ´åˆã¯ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã«ãªã‚‹ã‹ã‚‚ï¼‰ã®ç†è§£ã‚„çŸ¥è­˜ã‚’æ·±ã‚ã‚‹è‰¯ã„é¡Œæã ãªã¨æ„Ÿã˜ã¾ã—ãŸã€‚
ã“ã®è¾ºã‚Šã®ç†è§£ãŒæ·±ã¾ã‚‹ã¨ä¸­ç´šã‚¯ãƒ©ã‚¹ã®ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã¨ã—ã¦ã‚‚æ´»èºã§ãã‚‹ã¨æ€ã„ã¾ã™ã—ã€Pub/Subãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å®Ÿéš›ã«çµ„ã‚ã‚‹ã¨è¨­è¨ˆã®å¹…ã‚‚åºƒãŒã‚‹ã®ã§ã€ãœã²æŒ‘æˆ¦ã—ã¦ã¿ã¦ãã ã•ã„

/ä»¥ä¸Š







