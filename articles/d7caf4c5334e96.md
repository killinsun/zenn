---
title: "[Python] ChannelAccessToken v2.1 ã§ LINE BOTã‚’ä½œã‚‹"
emoji: "ğŸ”"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["LINEBot", "LINE", "Python", ]
published: false
---

LINE Messasging API ã‚’æ´»ç”¨ã—ã¦ LINE Bot ã‚’ä½œã‚‹ã¨ãã€ãƒãƒƒãƒˆã§ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚„ä½œä¾‹ã‚’ã¿ã‚‹ã¨ã€Œãƒãƒ£ãƒãƒ«ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆé•·æœŸï¼‰ã€ã¨ã€Œãƒãƒ£ãƒãƒ«ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã€ã‚’ä½¿ã£ã¦æ§‹ç¯‰ã™ã‚‹ä¾‹ãŒå¤šãã‚ã‚Šã¾ã™ã€‚
ç§ã‚‚ä»Šã¾ã§ãã®æ§‹æˆã§ BOT ã‚’é–‹ç™ºã—ã¦ã„ãŸã®ã§ã™ãŒã€ä»Šã¯ ã€ŒChannelAccessToken v2.1ã€ãªã‚‹ã‚‚ã®ãŒã‚ã‚Šã€ç¾åœ¨ã®æ¨å¥¨ã¨ã—ã¦å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«æ¡ˆå†…ã•ã‚Œã¦ã„ã¾ã™ã€‚

ãŸã ã€å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚„å…¬å¼SDKã®æƒ…å ±ã ã‘ã ã¨åˆå­¦è€…ã«ã¯ãƒãƒã‚Šã©ã“ã‚ã‚„æƒ…å ±ä¸è¶³æ„Ÿã‚‚å¦ã‚ãªã„ãŸã‚ã€å‚™å¿˜éŒ²ã¨ã—ã¦ç§ãªã‚Šã®ç®¡ç†æ–¹æ³•ã‚’è¨˜è¼‰ã—ã¾ã™ã€‚

## å‰æ

- LINE Developers Console ã§ãƒãƒ£ãƒãƒ«ã‚’é–‹è¨­æ¸ˆã¿
- Python + FastAPI

## ç”¨èªã¨ç”¨é€”

ã„ã‚ã„ã‚ã¨ç™»å ´äººç‰©ãŒå¤šãã€æ··ä¹±ã—ã‚„ã™ã„ã®ã§ã‹ã„ã¤ã¾ã‚“ã§èª¬æ˜ã—ã¾ã™ã€‚

### ãƒãƒ£ãƒãƒ«ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³

LINE ã® API ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã®ãƒˆãƒ¼ã‚¯ãƒ³ã€‚
ï¼”ç¨®é¡ã‚ã‚Šã€ãƒãƒƒãƒˆã§è¦‹ã‹ã‘ã‚‹ã®ã¯ç®¡ç†ç”»é¢ä¸Šã§å–å¾—å¯èƒ½ãªã€Œãƒãƒ£ãƒãƒ«ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³(é•·æœŸ)ã€ã¨ã„ã†ã‚‚ã®ã€‚

ãŠæ‰‹è»½ã ãŒã€ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†ã®æ–¹æ³•ãŒè„†å¼±ã ã¨ä¸æ­£åˆ©ç”¨ã•ã‚Œã‚‹æã‚ŒãŒã‚ã‚‹ãŸã‚ã€ã§ãã‚Œã°ã‚»ã‚­ãƒ¥ã‚¢ã«é‹ç”¨ã—ãŸã„å ´åˆã«ä»–ã®æ–¹æ³•ã‚’æ¤œè¨ã—ã¾ã™ã€‚
ä»Šå›ã¯Channel Access Token v2.1 ã¨ã„ã†ã€ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æœŸé–“ã‚’è‡ªåˆ†ã§è¨­å®šã§ãã‚‹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç™ºè¡Œã—ã¾ã™ã€‚


### ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ã‚­ãƒ¼ãƒšã‚¢

ã€Œå…¬é–‹éµã€ã¨ã€Œç§˜å¯†éµã€ã®ãƒšã‚¢ã®ã“ã¨ã‚’æŒ‡ã—ã¾ã™ã€‚
ã“ã®ã‚­ãƒ¼ãƒšã‚¢ã¯æ¼æ´©ãªã©ã—ãªã„é™ã‚Šã¯é•·æœŸã§ç®¡ç†ã—ã¦ã„ãã‚‚ã®ã§ã€ç‰¹ã«ã€Œç§˜å¯†éµã€ã¯ç’°å¢ƒå¤‰æ•°çµŒç”±ã§èª­ã¿è¾¼ã¾ã›ãŸã‚Šã€æš—å·åŒ–ã—ã¦ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ã™ã‚‹ãªã©ã®å¯¾å¿œãŒå¿…è¦ã§ã™ã€‚

### ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ç½²åã‚­ãƒ¼

JWTã‚’ç”Ÿæˆã™ã‚‹ãŸã‚ã®ã€Œå…¬é–‹éµã€å´ã®ã»ã†ã§ã™ã€‚ LINE Developers ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ç™»éŒ²ã™ã‚‹ã‚‚ã®ã§ã™ã€‚

### kid

ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ç½²åã‚­ãƒ¼ã®IDã§ã™ã€‚JWT ã‚’ç”Ÿæˆã™ã‚‹éš›ã«ä½¿ã„ã¾ã™ã€‚ã“ã®å€¤ã‚‚ä¿å­˜ã—ã¦ãŠãå¿…è¦ãŒã‚ã‚Šã¾ã™ãŒã€ã‚»ã‚­ãƒ¥ã‚¢ã«ä¿å­˜ã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

### JWT

ãƒãƒ£ãƒãƒ«ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ v2.1 ã‚’ç™ºè¡Œã™ã‚‹éš›ã€LINEã«é€ä¿¡ã™ã‚‹ãƒˆãƒ¼ã‚¯ãƒ³ã§ã™ã€‚

ç”Ÿæˆã™ã‚‹ãŸã‚ã«ã¯ã€ä»¥ä¸‹æƒ…å ±ãŒå¿…è¦ã§ã™ã€‚

- ãƒãƒ£ãƒãƒ«ID
- kid
- ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ã‚­ãƒ¼ãƒšã‚¢ã®ã€Œç§˜å¯†éµã€

### ãƒãƒ£ãƒãƒ«ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ

ãƒãƒ£ãƒãƒ«ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç™ºè¡Œã™ã‚‹éš›ã«ã¯å¿…è¦ã‚ã‚Šã¾ã›ã‚“ãŒã€Webhookã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ã‘å–ã‚‹éš›ã€æ­£è¦ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‹ç¢ºèªã™ã‚‹ãŸã‚ã«ç”¨ã„ã¾ã™ã€‚
ãã®ãŸã‚ã€ã“ã®å€¤ã‚‚ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ã‚­ãƒ¼ãƒšã‚¢ã¨åŒã˜ãã€ç’°å¢ƒå¤‰æ•°ã‚‚ã—ãã¯ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãªã©ã«ä¿å­˜ã—ã¦ãŠãã€å‘¼ã³å‡ºã›ã‚‹ã‚ˆã†ã«ã—ã¦ãŠãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ä»Šå›ã“ã“ã‚’æ‰±ã†é …ç›®ï¼ˆã‚¢ã‚¯ã‚»ã‚¹å…ƒã®æ¤œè¨¼ï¼‰ã«ã¤ã„ã¦ã¯è©³ã—ãå–ã‚Šä¸Šã’ã¾ã›ã‚“

## Channel Access Token v2.1ã‚’ç™ºè¡Œã™ã‚‹æµã‚Œ


### ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ã‚­ãƒ¼ãƒšã‚¢ã®ç”Ÿæˆ
ã¾ãšã€ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ã‚­ãƒ¼ãƒšã‚¢ã¨å‘¼ã°ã‚Œã‚‹å…¬é–‹éµã€ç§˜å¯†éµã‚’ç”Ÿæˆã—ã¾ã™ã€‚
ã“ã®æ‰‹é †ã§ã¯çœç•¥ã—ã¦ã„ã¾ã™ãŒã€ç§˜å¯†éµã¯ä¸Šè¿°ã®é€šã‚Šå®‰å…¨ã«ç®¡ç†ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```python
import jwk
import json

def generate_assertion_keypair() -> tuple(dict[str, str], dict[str, str]):
	key = jwk.JWK.generate(kty="RSA", size=2048, use="sig", alg="RS256")

	private_key = key.export_private()
	public_key = key.export_public()

	return private_key, public_key
```

ç”Ÿæˆã—ãŸ public_key ã¯ `dict` å‹ã®ãŸã‚ã€ä»¥ä¸‹ã®ã‚ˆã†ã« JSON å½¢å¼ã«ã—ã¦ãã ã•ã„

```python
import json

keypair = generate_assertion_keypair()
print(json.dumps(keypair[0],  indent=2))
```

å‡ºåŠ›ã•ã‚ŒãŸJSONã‚’ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ç½²åã‚­ãƒ¼ã®é …ç›®ã‹ã‚‰ç™»éŒ²ã—ã¾ã™ã€‚
![Alt text](/images/line_cat_v2_1_001.png)

ç™»éŒ²å¾Œã€è¡¨ç¤ºã•ã‚ŒãŸ `kid` ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãŠãã¾ã™ã€‚ã¾ãŸã€JWTã‚’ç”Ÿæˆã™ã‚‹éš›ã«å¿…è¦ã«ãªã‚‹ãŸã‚ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãªã©ã«ä¿å­˜ã—ã¦ãŠãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚(1ã¤ã®ãƒãƒ£ãƒãƒ«ã—ã‹ç®¡ç†ã—ãªã„å ´åˆã¯ãƒ™ã‚¿æ›¸ãã§ã‚‚å•é¡Œãªã„ã‹ã¨ã¯æ€ã„ã¾ã™)

### JWT ã®ç”Ÿæˆ

LINE Developers Consoleã§å–å¾—ã§ãã‚‹ã€Œãƒãƒ£ãƒãƒ«IDã€ã€ã€Œkidã€ã¨ã€ä¸Šè¨˜ã§ç”Ÿæˆã—ãŸã€Œç§˜å¯†éµã€ã®3ã¤ã‚’ç”¨ã„ã¦ JWT ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
ã“ã® JWT ã¯ã€ChannelAccessToken v2.1 ã‚’ç”Ÿæˆã™ã‚‹ãŸã‚ã«å¿…è¦ãªã‚‚ã®ã§ã™ã€‚

```python
import json
import jwt
from jwt.algorithms import RSAAlgorithm
from datetime import datetime

def generate_jwt(
		channel_id: str, kid: str, private_key: dict[str, str]
) -> str:

	# 30 minutes(JWT TTL)
	exp = int(datetime.now().timestamp() + 30 * 60)

	# 30 days(Channel Acess Token TTL)
	token_exp = 30 * 24 * 60 * 60

	header = {
		"alg": "RS256",
		"typ": "JWT",
		"kid": kid,
	}
	payload = {
		"iss": channel_id,
		"sub": channel_id,
		"aud": "https://api.line.me/",
		"exp": exp,
		"token_exp": token_exp,
	}

	private_key = assertion_key_pair.decrypt_private_key()
	key = RSAAlgorithm.from_jwk(json.dumps(private_key))

	return jwt.encode(
		payload, key=key, algorithm="RS256", headers=header, json_encoder=None
	)
```

- JWT ã‚’ä½¿ã„æ¨ã¦ã§é‹ç”¨ã™ã‚‹å ´åˆã€ `exp` ã¯ãªã‚‹ã¹ãçŸ­ãã™ã‚‹ã“ã¨ã‚’ãŠã™ã™ã‚ã—ã¾ã™ã€‚ä»Šå›ã®ä¾‹ã§ã¯ä½¿ã„æ¨ã¦ã‚’æƒ³å®šã—ãŸã‚³ãƒ¼ãƒ‰ã«ã—ã¦ã„ã¾ã™ãŒã€ä½¿ã„æ¨ã¦ã›ãšã€ç™ºè¡Œã—ãŸJWTã‚‚ä¸€æ™‚ä¿å­˜ã™ã‚‹ã‚±ãƒ¼ã‚¹ãŒã‚ã¾ã‚Šæ€ã„æµ®ã‹ã³ã¾ã›ã‚“ã§ã—ãŸã€‚
- Channel Access Tokenã® TTL `token_exp` ã¯ã€æœ€å¤§ 30æ—¥ã§ã™ã€‚è¦ä»¶ã«å¿œã˜ã¦å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚ã¾ãŸã€`exp`ã¨ç•°ãªã‚Šã€æœŸé™åˆ‡ã‚Œã«ãªã‚‹ã¾ã§ã®ç§’æ•°ã‚’æŒ‡å®šã—ã¾ã™ã€‚

ã“ã“ã¾ã§ã§å‰æº–å‚™ã¯å®Œäº†ã§ã™ã€‚

### ChannelAccessToken v2.1 ã®ç™ºè¡Œ

ä»¥é™ã¯ã€SDKã‚’é€šã˜ã¦BOTã‹ã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã™ã‚‹éš›ã«å‘¼ã³å‡ºã—ã¦ã„ãã€ã€ŒChannelAccesToken v2.1ã€ã®ç™ºè¡Œã«é–¢ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã®ä¾‹ã‚’è¦‹ã¦ã„ãã¾ã™ã€‚


```python
from abc import abstractmethod, ABC
from dataclasses import dataclass

@dataclass(frozen=True)
class ChannelAccessToken:
	access_token: str
	expires_in: int
	token_type: str
	key_id: str

	def to_dict(self):
		return {
			"access_token": self.access_token,
			"expires_in": self.expires_in,
			"token_type": self.token_type,
			"key_id": self.key_id,
		}


class ChannelAccessTokenIssuer:
	def __init__(self, channel_id: str, kid, str, private_key[str, str]):
		self.channel_id = channel_id
		self.kid = kid
		self.private_key = private_key

	def get(self) -> ChannelAccessToken:
		# 1: Redis ã‚„ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ã€æœ‰åŠ¹æœŸé™å†…ã®ãƒãƒ£ãƒãƒ«ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã™ã‚‹
		channel_access_token = SomeRepositoryClass.get(self.channel_id) 

		if channel_access_token is not None:
			return channel_access_token

		# 2: ã¾ã ãƒãƒ£ãƒãƒ«ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç™ºè¡Œã—ã¦ã„ãªã„å ´åˆã¯ LINE SDK ã‚’ç”¨ã„ã¦ç™ºè¡Œã™ã‚‹
		jwt = _get_jwt(self.channel_id, self.kid, self.private_key)
		SomeRepositoryClass.save(
			self.channel_id, channel_access_token,
		)

		return channel_access_token

	def _get_jwt(self, channel_id: str, kid: str, private_key: dict[str, str]) -> str:
		return generate_jwt(
			channel_id=channel_id,
			kid=kid,
			assertion_key_pair=private_key,
		)

	def _issue(jwt: str) -> ChannelAccessToken:
		line_api = LineChannelAccessToken()
		response = line_api.issue_channel_token_by_jwt(
			grant_type="client_credentials",
			client_assertion_type="urn:ietf:params:oauth:client-assertion-type:jwt-bearer",
			client_assertion=jwt,
		)

		return ChannelAccessToken(
			access_token=response.access_token,
			expires_in=response.expires_in,
			token_type=response.token_type,
			key_id=response.key_id,
		)
```

æœ€åˆã«ã©ã“ã‹ã®ãƒªãƒã‚¸ãƒˆãƒªå±¤ã‹ã‚‰ãƒãƒ£ãƒãƒ«ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ãŒãªã„ã‹ç¢ºèªã—ã€ã‚ã‚Œã°ãã‚Œã‚’ãã®ã¾ã¾è¿”å´ã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚
ç§ã®å ´åˆã€Redis ã«ä¿å­˜ã—ã¦ãŠã‚Šã€Rediså´ã§æœ‰åŠ¹æœŸé™ã‚’è¨­å®šã—ã¦ã„ã‚‹ã®ã§ã€æœŸé™åˆ‡ã‚Œã®ãƒˆãƒ¼ã‚¯ãƒ³ã¯è‡ªå‹•ã§ `None` ãŒè¿”ã•ã‚Œã‚‹ä»•çµ„ã¿ã«ã—ã¦ã„ã¾ã™ãŒã€ä»Šå›ã®ä¸»é¡Œã‹ã‚‰ã¯å¤–ã‚Œã‚‹ãŸã‚å‰²æ„›ã—ã¾ã™ã€‚

:::message
ãƒªãƒã‚¸ãƒˆãƒªå±¤ã¨ã„ã†è¨€è‘‰ã«é¦´æŸ“ã¿ãŒãªã„æ–¹ã¯ã€ã€Œã“ã“ã§ã¯äº‹å‰ã«ãƒãƒ£ãƒãƒ«ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ã—ã¦ã„ã¦ã€ãã‚Œã‚’èª­ã¿å‡ºã™å‡¦ç†ã‚’æ›¸ã„ã¦ã„ã‚‹ã‚“ã ãªã€ã¨æ€ã£ã¦ãŠã„ã¦ãã ã•ã„
:::


### ç™ºè¡Œã—ãŸChannelAccessTokenã‚’ç”¨ã„ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã™ã‚‹

```python
from linebot.v3 import WebhookParser
from linebot.v3.exceptions import InvalidSignatureError
from linebot.v3.messaging import (
	Configuration,
	ApiClient,
	MessagingApi,
	TextMessage,
	ReplyMessageRequest,
)
from linebot.v3.webhooks import MessageEvent, TextMessageContent

async def get_body(request: Request):
	return await request.body()


@router.post(
	"/webhook",
	status_code=200,
	tags=["Line"],
)
def process_webhook(
	x_line_signature: str = Header(None, alias="X-Line-Signature"),
	body: bytes = Depends(get_body),
):
	"""An endpoint to process LINE webhook."""
	body_text = body.decode("utf-8")

	channel_id = "..." # ä½•ã‹ã—ã‚‰ã§ãƒãƒ£ãƒãƒ«IDã‚’å–å¾—ã™ã‚‹
	kid = "..." # ä½•ã‹ã—ã‚‰ã§ kid ã‚’å–å¾—ã™ã‚‹
	channel_secret = "..." # ä½•ã‹ã—ã‚‰ã§ãƒãƒ£ãƒãƒ«ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’å–å¾—ã™ã‚‹
	private_key = {} # ä½•ã‹ã—ã‚‰ã§ç§˜å¯†éµã‚’å–å¾—ã™ã‚‹

	# ãƒãƒ£ãƒãƒ«ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç™ºè¡Œã¾ãŸã¯å–å¾—ã™ã‚‹
	channel_access_token_issuer = ChannelAccessTokenIssuer(
		channel_id=channel_id,
		kid=kid,
		private_key=private_key
	)
	channel_assess_token = channel_access_token_issuer.get()

	# ãƒãƒ£ãƒãƒ«ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”¨ã„ã¦Messaging API ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–
	configuration = Configuration(access_token=channel_access_token.access_token)
	api_client = ApiClient(configuration)
	line_bot_api = MessagingApi(api_client)

	parser = WebhookParser(channel_secret)

	try:
		events = parser.parse(body_text, x_line_signature)
	except InvalidSignatureError:
		raise HTTPException(status_code=400, detail="Invalid signature")

	# å—ã‘å–ã£ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å‡¦ç†
	for event in events:
		logger.info(event)
		if not isinstance(event, MessageEvent):
			continue
		if not isinstance(event.message, TextMessageContent):
			continue

		line_bot_api.reply_message(
			ReplyMessageRequest(
				reply_token=event.reply_token,
				messages=[TextMessage(text="ã“ã‚“ã«ã¡ã¯ï¼")],
			),
		)

	return "ok"
```

- å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ã¯ã˜ã‚ã¨ã—ãŸå¤šãã®ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã§ã¯éåŒæœŸ(async)ãƒ«ãƒ¼ãƒˆã§ request.body ã‚’å–å¾—ã—ã€X-Line_Signature ã¨çµ„ã¿åˆã‚ã›ã¦æ¤œè¨¼ã™ã‚‹ä¾‹ã‚’è¨˜è¼‰ã—ã¦ã„ã¾ã™ãŒã€ä»Šå›ã¯äº‹æ•…ãŒå°‘ãªã„åŒæœŸãƒ«ãƒ¼ãƒˆã§request.bodyã‚’å–å¾—ã—ã¦ã„ã¾ã™ã€‚
- ãƒãƒ£ãƒãƒ«ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ãƒ»ç™ºè¡Œã—ã¦ã—ã¾ãˆã°ã€ `Configuration`ã‚¯ãƒ©ã‚¹ã«ã‚»ãƒƒãƒˆã—ã¦`ApiClient`ã€`MessagingApi`ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚ã“ã“ã¾ã§ã§ãã¦ã—ã¾ãˆã°ã‚ã¨ã¯ä»–ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ç¤ºã—ã¦ã„ã‚‹ã‚ˆã†ãªã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã¯å‹•ã‹ã›ã‚‹ã¯ãšã§ã™ã€‚


## ãƒãƒã£ãŸãƒã‚¤ãƒ³ãƒˆ

### JWTç”Ÿæˆæ™‚ã® `aud` ã‚’æ­£ç¢ºã«è¨˜è¿°ã—ã¦ã„ãªã‹ã£ãŸ

ãã“ã¾ã§ãƒ‰ãƒ„ãƒœã«ãƒãƒã£ãŸã‚ã‘ã§ã‚‚ãªã„ã§ã™ãŒã€JWT ã‚’ç”Ÿæˆã™ã‚‹éš›ã¯ `aud` ã¨ã„ã†ã‚­ãƒ¼ã« `https://api.line.me/`ã‚’æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ã“ã®æ™‚ Trailing slash ã‚„ãƒ—ãƒ­ãƒˆã‚³ãƒ«é•ã„ã¯è€ƒæ…®ã•ã‚Œã¦ã„ãªã„ã®ã§æ­£ç¢ºã«å…¥åŠ›ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã—ãŸã€‚
ç§ã®å ´åˆã€ `https://api.line.me` ã¨ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ç„¡ã—ã§å…¥åŠ›ã—ã¦ã„ãŸãŸã‚ã«ã€ãƒˆãƒ¼ã‚¯ãƒ³ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚


### SDK ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒå¤ã„å ´åˆã€LINE SDK ã‚’ç”¨ã„ãŸ ChannelAccessToken ãŒç™ºè¡Œã§ããªã„

å¯¾å¿œã—ã¦ã„ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ä½¿ã£ã¦ã„ãŸ SDK ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯ `3.1.0` ã ã£ãŸã®ã§ã™ãŒã€`3.5`ä»¥ä¸Šã§ãªã„ã¨ä¸Šè¨˜ã‚³ãƒ¼ãƒ‰ã¯å‹•ãã¾ã›ã‚“ã€‚
ç†ç”±ã¯ ChanelAccessToken v2.1 ã‚’ç™ºè¡Œã™ã‚‹éš›ã€ã“ã®æ™‚ç‚¹ã§ã¯ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã¯æŒã£ã¦ã„ãªã„ã¯ãšã§ã™ãŒã€ç™ºè¡Œæ™‚ã«ã‚¨ãƒ©ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

ã‚¨ãƒ©ãƒ¼ã®å†…å®¹ã¨ã€SDKå´ã®ã‚³ãƒ¼ãƒ‰ã‚’èª­ã‚“ã§ã¿ãŸã¨ã“ã‚ã€SDKå´ã§ã¯å†…éƒ¨çš„ã«ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ãŒãªã„ã¨ LINE å´ã® API ã‚’å‘¼ã³å‡ºã›ãªã„ä»•æ§˜ã¨ãªã£ã¦ãŠã‚Šã€çŸ›ç›¾ãŒç”Ÿã˜ã¦ã„ã¾ã—ãŸã€‚
å¿µã®ç‚º JavaScript ç‰ˆã®ã‚³ãƒ¼ãƒ‰ã‚‚èª­ã‚“ã§ã¿ãŸã®ã§ã™ãŒã€ChannelAccessToken ã‚’ç™ºè¡Œã™ã‚‹ãŸã‚ã®ã‚¯ãƒ©ã‚¹ã€APIã«é–¢ã—ã¦ã¯ã“ã‚Œã‚’å¿…è¦ã¨ã—ãªã„ãŸã‚ã€å•é¡Œãªãç™ºè¡Œã§ãã‚‹ä»•æ§˜ã§ã—ãŸã€‚

ç§ã®ãŠã£ã¡ã‚‡ã“ã¡ã‚‡ã„ã§ã€ã“ã‚Œã«é–¢ã—ã¦ã¯ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ã§è§£æ±ºã™ã‚‹ã¨çŸ¥ã‚‰ãšã€å…¬å¼ã®ãƒªãƒã‚¸ãƒˆãƒªã§å•ã„åˆã‚ã›ã¾ã—ãŸã€‚

https://github.com/line/line-bot-sdk-python/issues/587

åˆ©ç”¨ã—ã¦ã„ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®æŒ™å‹•ã«é•å’Œæ„Ÿã‚„ãƒã‚°ã‚’è¦‹ã¤ã‘ãŸéš›ã€ã¾ãšã¯æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§è§£æ±ºã™ã‚‹ã‹ç¢ºèªã™ã‚‹ã€ã¨ã„ã†åŸºæœ¬ã‚’æ€ ã£ã¦ã„ã¦ã®ã§ã€æ”¹ã‚ç›´ã™è‰¯ã„æ©Ÿä¼šã§ã—ãŸã€‚


## å‚è€ƒ

[ãƒãƒ£ãƒãƒ«ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³v2.1ã‚’ç™ºè¡Œã™ã‚‹](https://developers.line.biz/ja/docs/messaging-api/generate-json-web-token/#issue_a_channel_access_token_v2_1)

[Goã§LINE Messaging APIã®ãƒãƒ£ãƒãƒ«ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³v2.1ã‚’å–å¾—ã™ã‚‹
](https://zenn.dev/akira_kashihara/articles/2a00f4f67ae48a)