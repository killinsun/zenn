---
title: "SendGrid ã®Inbound Email Parse Webhook ã§å—ã‘å–ã£ãŸãƒ¡ãƒ¼ãƒ«ã‹ã‚‰æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—ã™ã‚‹"
emoji: "âœ‰ï¸"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["SendGrid", "FastAPI", "Python"]
published: false
---

SendGrid ã®å…¬å¼ã§ã€ Python ã®ã‚µãƒ³ãƒ—ãƒ«ã‚’è¦‹ã‚‹ã¨ Flask ã ã£ãŸã®ã§ã€ FastAPI ã ã£ãŸã‚‰ã©ã†æ›¸ãã‹ãƒ¡ãƒ¢ã€‚
çµè«–ã€FastAPI ã‚‰ã—ã„æ›¸ãæ–¹ã§æ›¸ãã“ã¨ã¯ã§ããšã€Flask ã®æ›¸ãæ–¹ã¨ã»ã¼åŒä¸€ã«ãªã£ã¦ã—ã¾ã£ãŸ ğŸ˜¢(ç†ç”±ã¯å¾Œè¿°)

## ã‚³ãƒ¼ãƒ‰

```python

@router.post(
    "/webhook",
    status_code=status.HTTP_200_OK,
)
async def sendgrid_webhook( # 1
    request: Request,
):
    form = await request.form()
    headers = form.get("headers")
    envelope = form.get("envelope")
    subject = form.get("subject")
    text = form.get("text")
    html = form.get("html")
    charsets = form.get("charsets")
    num_attachments = int(form.get("attachments")) # 2

    attachments = []
    for i in range(1, num_attachments + 1):
        uploaded_file: UploadFile = form.get(f"attachment{i}") # 3
        if uploaded_file is not None:
            contents = await uploaded_file.read()
            attachments.append(
                {
                    "filename": uploaded_file.filename,
                    "contents": contents,
                    "type": uploaded_file.content_type,
                }
            )
		return {"message": "ok" }

```

1. ã‚‚ã¨ã‚‚ã¨ Webhook ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯åŒæœŸé–¢æ•°ã§æ›¸ã„ã¦ã„ãŸãŒã€Request ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ‰±ã†éƒ½åˆä¸Šã€éåŒæœŸé–¢æ•°ãŒå¿…é ˆã«ãªã‚‹ã€‚
   å®Ÿéš›ã®ã‚³ãƒ¼ãƒ‰ã§ã¯ã€åŒæœŸå‡¦ç†ã ã£ãŸéƒ¨åˆ†ã¯ `starlette.concurrency.run_in_threadpool` ãƒ¡ã‚½ãƒƒãƒ‰ã«æŠ¼ã—è¾¼ã‚“ã ã€‚
2. Inbound Email Parse Webhook ã§ã¯ `attachments` ã«æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã®æ•°ãŒ str å‹ã§æ¸¡ã•ã‚Œã‚‹ã®ã§ã€ int ã«ã‚­ãƒ£ã‚¹ãƒˆã™ã‚‹
3. å®Ÿéš›ã®æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‡ãƒ¼ã‚¿éƒ¨åˆ†ã¯ `attachment{n}` ã¨å‹•çš„ãªã®ã§ã€ãƒ«ãƒ¼ãƒ—ã§å›ã—ã¦å–å¾—ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚ã“ã®å¼•æ•°åãŒå‹•çš„ãªãŸã‚ã€Request ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½¿ã‚ã–ã‚‹ã‚’å¾—ãªã‹ã£ãŸã€‚

---

/ä»¥ä¸Š
